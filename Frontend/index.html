<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>EIMC - VP </title>

  <link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.indigo-pink.min.css">
  <link rel="stylesheet" href="styles/index.css">
</head>

<body mode="maker">
  <header class="mdl-color--cyan-500">
    <h1 class="mode-maker">EIMC - VP <h1>
  </header>

  <main>

    <div class="blockly-editor" />
    <div id="blocklyDiv" style="height: 600px; width: 100%;"></div>
    <button id="toggleVisiCodeButton" onclick="toggleVisiCode()"> Code </button>
    <button id="toggleVisiStatusButton" onclick="toggleVisiStatus()"> Status </button>
    <button id="ExecuteButton" onclick="send_code()"> Execute </button>
    <a  id="ReportFileHref">Report File</a>


    <textarea id="statusarea" rows="10" style="width: 95%; display: none"></textarea>
    <textarea id="codearea" rows="10" style="width: 95%; display: none">

      </textarea>
    <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
      <category name="Start">
        <block type="importmodel"></block>
        <block type="applicability"></block>
        <block type="validation"></block>
     
        <block type="exportmodel" disabled="true"></block>
    </category>
    
   

    <category name="Template Start">
        <block type="importmodel">
          <next>
            <block type="applicability">
              <next>

                <block type="validation">
                </block>

              </next>
            </block>
          </next>
        </block>
      </category>

      <sep></sep>
      <category name="Filter Operators">
        <label text="TypeFilter"></label>
        <sep gap="12"></sep>
        <block type="type_filter">

          <value name="NAME">
            <shadow type="Test_identifier"></shadow>
          </value>

        </block>

        <label text="PropertyFilter"></label>
        <sep gap="12"></sep>
        <block type="property_filter"></block>


        <label text="AttributeFilter"></label>
        <sep gap="12"></sep>
        <block type="attribute_filter"></block>
      </category>

      <category name="Check Operators">
        <label text="XCheck"></label>
        <sep gap="12"></sep>
        <block type="xchecktest"></block>

        <label text="PropertyCheck"></label>
        <sep gap="12"></sep>
        <block type="Propertychecktest"></block>

        <label text="AttributeCheck"></label>
        <sep gap="12"></sep>
        <block type="Attributechecktest"></block>
      </category>

      <category name="Geometry Operators">
        <label text="Geometry Operators"></label>
        <sep gap="12"></sep>

        <block type="Touchoperator"></block>
        <block type="Insidelist"></block>

        <label text="    ...     "></label>

        <label text="Separator"></label>
        <sep gap="12"></sep>

        <block type="line"></block>

        <label text="Topological Index Identifier"></label>
        <sep gap="12"></sep>
        <block type="topo"></block>
        <block type="topozwischen"></block>
    </category>
    
    <category name="General Operators">
        <block type="Projector" disabled="true">
        <value name="NAME">
            <shadow type="integernode">
              <field name="o">1</field>
            </shadow>
          </value>
        </block>

        <label text="    ...     "></label>
      </category>

      <sep></sep>
      <category name="Identifier">
        <label text="Property Specification"></label>
        <sep gap="12"></sep>
        <block type="property_identifier"></block>
        <sep gap="8"></sep>
        <block type="propertyset_identifier"></block>

        <label text="Attribute Specification"></label>
        <sep gap="12"></sep>
        <block type="attribute_identifier"></block>

        <label text="Entity Specification"></label>
        <sep gap="12"></sep>
        <block type="Test_identifier"></block>
      </category>

      <category name="Specificators">
        <label text="Logical Specificators"></label>
        <sep gap="12"></sep>
        <block type="istgleich"></block>
        
        <label text="Simple Data Type"></label>
        <sep gap="12"></sep>
        <block type="trueblocks"></block>
        <sep gap="8"></sep>
        <block type="integernode"></block>
        <sep gap="8"></sep>
        <block type="integernodezwischennode"></block>
        <sep gap="8"></sep>
        <block type="Identifier"></block>
    
    
        
        
      
    </category>
    <sep></sep>
    
    <category name="Use Case">
        <block type="importmodel">
          <field name="Importquery">"sample10_tagx.ifc"</field>
          <next>
            <block type="applicability">
              <value name="NAME">
                <block type="type_filter">
                  <value name="NAME">
                    <block type="Test_identifier">
                      <field name="testdrop">IfcWindow</field>
                    </block>
                  </value>
                </block>
              </value>
              <next>
                <block type="applicability">
                  <value name="NAME">
                    <block type="type_filter">
                      <value name="NAME">
                        <block type="Test_identifier"></block>
                      </value>
                      <next>

                        <block type="property_filter">
                          <value name="Property_Filter">
                            <block type="property_identifier">
                              <field name="Drop">LoadBearing</field>
                              <value name="own_entity">
                                <block type="trueblocks"></block>
                              </value>
                            </block>
                          </value>
                        </block>
                      </next>
                    </block>
                  </value>
                  <next>
                    <block type="validation">
                      <value name="NAME">
                        <block type="xchecktest">
                          <mutation items="1"></mutation>
                          <value name="ADD0">
                            <block type="property_identifier">
                              <field name="Drop">ThermalTrancemittance</field>
                              <value name="own_entity">
                                <block type="istgleich">
                                  <field name="k"></field>
                                    
                                      <value name="ist">
                                        <block type="Identifier">
                                          <field name="Tt">1.3</field>
                                        </block>
                                      </value>
                            </block>
                          </value>
                        </block>
                      </value>
                    </block>                      
                  </value>
                  </block>
                  </next>
                </block>
              </next>
            </block>
          </next>
        </block>
      </category>
  </main>

  <script>
    var workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });
  </script>


  <script src="https://unpkg.com/blockly"></script>
  <script src="scripts/Blockstest.js"></script>
  <script src="scripts/geometryOperators.js"></script>
  <script src="scripts/Checkoperators.js"></script>
  <script src="scripts/main.js"></script>
  <script src="scripts/CodeGenerator.js"></script>
  <script src="blockly_compressed.js"></script>
  <script src="javascript_compressed.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <script>
    function get_code(){
      Blockly.JavaScript.addReservedWords('code');
      var code = Blockly.JavaScript.workspaceToCode(workspace);

      code = "{" + code.replace(/,\s*]/g, ']') + "}";
      code = code.replace(";;\"", "\"");
      return code
    }

    function pretty_code_area(){
      carea = document.getElementById("codearea");
      var jcode = JSON.parse(get_code())
      var jsonPretty = JSON.stringify(jcode, null, 2);
      carea.value = jsonPretty;
    }

    function send_code(){
      jcode = get_code()

      if(interval == undefined){
        getStatusEvery();
      }

      axios({
        method: 'post',
        url: 'http://localhost:9000/query',
        headers: {
        'Content-Type': 'text/plain'
        },
        data: jcode
      });
    }


    function toggleVisiCode(){
      pretty_code_area()
      toggleVisi("codearea", "toggleVisiCodeButton")
    }

    let interval = undefined
    function getStatusEvery(){
      if(interval == undefined){
        interval = setInterval(function() {
          getStatus()
        }, 500);
        return
      }
      else
      { 
        clearInterval(interval);
        interval = undefined;
        document.getElementById("statusarea").value = "";
      }
    }



    function getStatus(){
      axios.get('http://localhost:9000/query', {
        headers: {
          'Content-Type': 'text/plain'
        }
      })
      .then(function (response) {
        data = response.data
         statusarea = document.getElementById("statusarea");
         statusarea.value += data
        if (data.startsWith("%report_")){

          clearInterval(interval);
          interval = undefined;
          statusarea.style.display === "none"

          var res = data.substring(8, data.length)

          reportHref = document.getElementById("ReportFileHref");
          reportHref.innerHTML = "Report File: " + res;
          reportHref.setAttribute('href', "http://localhost:9000/reports/" + res);
        }
      })
      .catch(function (error) {
        console.log(error);
      });
    }

    function toggleVisiStatus(){
      status = toggleVisi("statusarea", "toggleVisiStatusButton")

        getStatusEvery()
      
    }

    function toggleVisi(elementId, buttonId) {

      status = "none"
      var element= document.getElementById(elementId);
      if (element.style.display === "none") {
        element.style.display = "block";
        status = "block"
      } else {
        element.style.display = "none";
      }

      var bt_element = document.getElementById(buttonId);
      if (element.style.display === "none") {
        bt_element.style.background = "#D3D3D3";
      } else {
        bt_element.style.background= "#e7e7e7"; 
      }

      return status
  }
  </script>

</body>

</html>

